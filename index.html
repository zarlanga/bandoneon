<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Frankenpiano</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  
   <script>

    $(document).ready(function(){
      $("body").keydown(function(e){
        e.preventDefault();
        var keyCode = e.keyCode || e.which;
        //console.log(keyCode);
         tirarnota(entrakeysalenota(keyCode,true));
        resaltarNota(entrakeysalenota(keyCode), true);
      });
      
      $("body").keyup(function(e){
        resaltarNota(entrakeysalenota(e.keyCode), false);
      });
      
    });


  </script>
  <style>
   
    
    /*
    .botonota{
      width: 40px;
      height: 40px;
      display: inline-block;
      border-radius: 22px;
      border: 2px solid black;
      text-align:center;
      margin:15px 10px;
      background:white;
    }
    #contBand{
      padding:30px;
      background:silver;
    }
    #row1, #row2, #row3, #row4, #row5 {
      display:flex;
      justify-content:space-evenly;
    }*/
    *{
      margin:0;
      padding:0;
    }
     img{
      width:60vw;
      z-index:10; 
    }
    #sobrecontainer{
      text-align:center;
      background:silver;
      font-size:0;
    }
    .container{
      display:inline-block;
      position:relative;
      top:0;
            
    }
    .overlay{
      font-size:12px;
      width:2.18vw;
      height:10vh;
      background:rgba(100,100,100,0.5);
      z-index:30;
      display:inline-block;
    /*  border:1px red solid;*/
    }
    #tiagarro1{
      position:absolute;
      top:3vh;
      left:3.7vw;
    }
    
     #tiagarro2{
      position:absolute;
      top:2.5vh;
      left:3.7vw;
    }
    
    #tiagarro2 .overlay{
      width:2.9vw;
    }
    #overnota12{
      margin-left:1.6vw
    }
    #overnota36{
      margin-left:1.6vw;
    }
	</style>
 <script>
   
   $(document).ready(function(){
     var moneda=true;
     for(var i= 0; i<39;i++){
      // var c= moneda ? i*10 : 250 - i*10
        var c= moneda ? 50 : 200
       var color =`rgb(${c},${c},${c}) `
       var testo= `<div class="overlay"style="background:${color};opacity:0;" id="overnota${i}"></div>`
       if(i<24){
       $("#tiagarro1").append(testo)
         }else{
      $("#tiagarro2").append(testo)
         }
       //$("#tiagarro" + i<24 ? "1" : "2").append(testo)
       moneda= !moneda;
     }
   });
   
   function resaltarNota(n, bool){
     console.log("opa"+n);
     $("#overnota"+n).css("opacity",bool ? "0.5": "0");
   }
   </script>
</head>
<body>
  
  <div id="sobrecontainer">
    <img src="https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fdisposicion1%20teclas.jpg?v=1590790495439">
    <div class="container">
      <img src="https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fdisposicion1%20notas1.jpg?v=1590790494721">
      <div id="tiagarro1">
        asdfasdf
      </div>
    </div>
    <div class="container">
    <img src="https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fdisposicion1%20notas2.jpg?v=1590790494341">
      <div id="tiagarro2">
        asdfasdf
      </div>
    </div>
  </div>
  <!--<div id="contBand">
    <div id="row5"></div>
    <div id="row4"></div>
    <div id="row3"></div>
    <div id="row2"></div>
    <div id="row1"></div>
	</div>
  <br>-->
  <script>
  /*for(i=40;i<=75;i++) {
    var test = `<button onclick="playaudio(${i})">--${i}---</button>`
     $("body").append(test);
    
  }
  var notasText= ["C#4","A6","F#6","E6","Eb6",
					"C4","D4","G4","Bb5","C6","D6",
					"B3","E4","C#5","F#4","A4","C5","E5",
					"A3","F4","Bb4","G#4","B4","D5","G#5","B5",
					"Bb3","Eb4","F5","Eb5","F#5","A5","C#6","G5"];
	
	var colores = ["cyan","olive","yellow","gray"]
					
	var row = 5;
  
  for (var i = 1; i<35; i++){
		//var testo = `<div class="botonota">${notasText[i-1]}</div>`;
		var testo = `<div class="botonota" id="tecla${i}">${notasText[i-1]}</div>`;
		if (i==6 || i==12 || i == 19 || i == 27) row--;
		$("#row"+row).append(testo);
		$("#tecla"+i).css("background-color", colores[notasText[i-1].substr(-1)-3] );
	}
	*/
	
  var suspenderNotas=[];
    
  var notas = [65, 90,87,51,115,52,88,69,83,84,53,70,89,68,71,85,82,72,86,73,67,66,188,74,78];
  
  function entrakeysalenota(n,bool){
		var ret = notas.indexOf(n);
		if(bool) $("body").append("<br>,"+n);
		//return ret != -1 ? ret: 0;
    return ret
	}
  
  function tirarnota(tecl){	
    console.log(tecl+39);
    if(tecl>=0) playaudio(tecl+39);
  }
   /* 
  function cargarNotaHold(n) {
    suspenderNotas.push(n);
  }
  
  function descargarNotaHold(n){
    
  }*/
    
    
 
    
    /******************************************************************************/ 
    /******************************************************************************/ 
    /******************************************************************************/ 
    /******************************************************************************/ 
    
    
  var g_instrument = 'Piano';
  
  function threshold(n) { var log8ile = Math.log(n)/Math.log(8); return (log8ile == Math.floor(log8ile)); }

  var AudioContext = window.AudioContext || window.webkitAudioContext;
  var audiocontext = new AudioContext();
  var piano7sounds = [];
  for (var i=24; i<=108; i++) piano7sounds[i] = null;
  
 /* var urlsG=["https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fd3.mp3?v=1590711281058",
             "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fa4.mp3?v=1590711070510",
             "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fe4.mp3?v=1590711070546",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fb5.mp3?v=1590711070887",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Ff-5.mp3?v=1590711071048"]
*/
  var urlsG=["https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fsol%202%2B.wav?v=1590779270760",
             "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fre%203%2B.wav?v=1590777317892",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fla%203%2B.wav?v=1590777316166",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fmi%204%2B.wav?v=1590777316937",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fsi%204%2B.wav?v=1590777317258",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Ffa%20%235%2B.wav?v=1590777317355"];
            
  function piano7loadsound(n){
    var request = new XMLHttpRequest();
    request.open("get", n == 37 ? urlsG[0] :n == 44 ? urlsG[1] : n == 51 ? urlsG[2] :
                n == 58 ? urlsG[3] : n == 65 ? urlsG[4] : n == 72 ? urlsG[5] : ""   , true); //n dividido 7?
    request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    request.responseType = "arraybuffer";
    request.onload =
      function() {
        audiocontext.decodeAudioData (
          request.response,
          function(buffer) {
            if (!buffer) { console.error('error decoding file data ('+n+'): ' + url); return; }
            piano7sounds[n] = buffer;
          },
          function(error) { console.error('decodeAudioData error ('+n+'): ', error); 
          }
        );
      }
    request.onerror = function() { console.error('BufferLoader: XHR error ('+n+')'); }
    request.send('n='+n);
  }

  function piano7loadbasic(){
    piano7loadsound(37);
    piano7loadsound(44); piano7loadsound(51); piano7loadsound(58);
   piano7loadsound(65); piano7loadsound(72);
  }

  function sustain_sourcestart(n,rate,delayInSeconds) {
    if (audiocontext.state == 'suspended') audiocontext.resume();
    var source = audiocontext.createBufferSource();
    source.buffer = piano7sounds[n];
    source.playbackRate.setValueAtTime(rate,0);
    source.connect(audiocontext.destination);
    source.start(audiocontext.currentTime + delayInSeconds);
  }

  function sourcestart(n,rate,delayInSeconds) {
   //if (susbox.checked) { sustain_sourcestart(n,rate,delayInSeconds); return; }
    //if (true) { sustain_sourcestart(n,rate,delayInSeconds); return; }
    if (audiocontext.state == 'suspended') audiocontext.resume();
    var volume = 1;
    var duration = 0.6; // in seconds
    var start = audiocontext.currentTime + delayInSeconds;
    var stop = start + duration;
    var gainNode = audiocontext.createGain();
    gainNode.gain.setValueAtTime(volume, start);
    gainNode.gain.linearRampToValueAtTime(1, stop);
    gainNode.gain.linearRampToValueAtTime(0, stop+0.1);
    gainNode.connect(audiocontext.destination);
    var source = audiocontext.createBufferSource();
    source.buffer = piano7sounds[n];
    source.playbackRate.setValueAtTime(rate,0);
    source.connect(gainNode);
    source.start(start); 
    console.log("sasasa");
  }

  function playpiano7sound(n,delayInSeconds) {
    delayInSeconds = delayInSeconds || 0;
    if (delayInSeconds > 0) setTimeout( "recordnow("+n+");" , delayInSeconds*1000);	
    if (n <= 28) return sourcestart(24,Math.pow(2,(n-24)/12),delayInSeconds);
    if (n >= 93) return sourcestart(93,Math.pow(2,(n-93)/12),delayInSeconds);
    if (n%7 == 2) return sourcestart(n,1,delayInSeconds);
    if (n%7 == 3) return sourcestart(n-1,Math.pow(2,1/12),delayInSeconds);
    if (n%7 == 4) return sourcestart(n-2,Math.pow(2,2/12),delayInSeconds);
    if (n%7 == 5) return sourcestart(n-3,Math.pow(2,3/12),delayInSeconds);
    if (n%7 == 6) return sourcestart(n+3,Math.pow(2,-3/12),delayInSeconds);
    if (n%7 == 0) return sourcestart(n+2,Math.pow(2,-2/12),delayInSeconds);
    if (n%7 == 1) return sourcestart(n+1,Math.pow(2,-1/12),delayInSeconds);
  }

  function playpianosound(context,n,delayInSeconds) {
    playpiano7sound(n,delayInSeconds);
    //console.log("culo");
  }

   
  function playaudio(n) {
    playpianosound(audiocontext,n);
  }

  piano7loadbasic()
  
  </script>
</body>
</html>
