<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Frankenpiano</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
    .botonota{
      width: 40px;
      height: 40px;
      display: inline-block;
      border-radius: 22px;
      border: 2px solid black;
      text-align:center;
      margin:15px 10px;
      background:white;
    }
    #contBand{
      padding:30px;
      background:silver;
    }
    #row1, #row2, #row3, #row4, #row5 {
      display:flex;
      justify-content:space-evenly;
    }
	</style>
<script>
  
  $(document).ready(function(){
    $("body").keydown(function(e){
      e.preventDefault();
      var keyCode = e.keyCode || e.which;
      //console.log(keyCode);
       tirarnota(entrakeysalenota(keyCode));
    });
  });
  
  var g_instrument = 'Piano';
  
  function threshold(n) { var log8ile = Math.log(n)/Math.log(8); return (log8ile == Math.floor(log8ile)); }

  var AudioContext = window.AudioContext || window.webkitAudioContext;
  var audiocontext = new AudioContext();
  var piano7sounds = [];
  for (var i=24; i<=108; i++) piano7sounds[i] = null;
  
 /* var urlsG=["https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fd3.mp3?v=1590711281058",
             "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fa4.mp3?v=1590711070510",
             "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fe4.mp3?v=1590711070546",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fb5.mp3?v=1590711070887",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Ff-5.mp3?v=1590711071048"]
*/
  var urlsG=["https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fsol%202%2B.wav?v=1590779270760",
             "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fre%203%2B.wav?v=1590777317892",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fla%203%2B.wav?v=1590777316166",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fmi%204%2B.wav?v=1590777316937",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Fsi%204%2B.wav?v=1590777317258",
            "https://cdn.glitch.com/a15c2729-c203-4a18-a5ba-1bf43a9da91c%2Ffa%20%235%2B.wav?v=1590777317355"];
            
  function piano7loadsound(n){
    var request = new XMLHttpRequest();
    request.open("get", n == 37 ? urlsG[0] :n == 44 ? urlsG[1] : n == 51 ? urlsG[2] :
                n == 58 ? urlsG[3] : n == 65 ? urlsG[4] : n == 72 ? urlsG[5] : ""   , true); //n dividido 7?
    request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    request.responseType = "arraybuffer";
    request.onload =
      function() {
        audiocontext.decodeAudioData (
          request.response,
          function(buffer) {
            if (!buffer) { console.error('error decoding file data ('+n+'): ' + url); return; }
            piano7sounds[n] = buffer;
          },
          function(error) { console.error('decodeAudioData error ('+n+'): ', error); 
          }
        );
      }
    request.onerror = function() { console.error('BufferLoader: XHR error ('+n+')'); }
    request.send('n='+n);
  }

  function piano7loadbasic(){
    piano7loadsound(37);
    piano7loadsound(44); piano7loadsound(51); piano7loadsound(58);
   piano7loadsound(65); piano7loadsound(72);
  }

  function sustain_sourcestart(n,rate,delayInSeconds) {
    if (audiocontext.state == 'suspended') audiocontext.resume();
    var source = audiocontext.createBufferSource();
    source.buffer = piano7sounds[n];
    source.playbackRate.setValueAtTime(rate,0);
    source.connect(audiocontext.destination);
    source.start(audiocontext.currentTime + delayInSeconds);
  }

  function sourcestart(n,rate,delayInSeconds) {
   //if (susbox.checked) { sustain_sourcestart(n,rate,delayInSeconds); return; }
    //if (true) { sustain_sourcestart(n,rate,delayInSeconds); return; }
    if (audiocontext.state == 'suspended') audiocontext.resume();
    var volume = 1;
    var duration = 0.6; // in seconds
    var start = audiocontext.currentTime + delayInSeconds;
    var stop = start + duration;
    var gainNode = audiocontext.createGain();
    gainNode.gain.setValueAtTime(volume, start);
    gainNode.gain.linearRampToValueAtTime(1, stop);
    gainNode.gain.linearRampToValueAtTime(0, stop+0.1);
    gainNode.connect(audiocontext.destination);
    var source = audiocontext.createBufferSource();
    source.buffer = piano7sounds[n];
    source.playbackRate.setValueAtTime(rate,0);
    source.connect(gainNode);
    source.start(start); 
    console.log("sasasa");
  }

  function playpiano7sound(n,delayInSeconds) {
    delayInSeconds = delayInSeconds || 0;
    if (delayInSeconds > 0) setTimeout( "recordnow("+n+");" , delayInSeconds*1000);	
    if (n <= 28) return sourcestart(24,Math.pow(2,(n-24)/12),delayInSeconds);
    if (n >= 93) return sourcestart(93,Math.pow(2,(n-93)/12),delayInSeconds);
    if (n%7 == 2) return sourcestart(n,1,delayInSeconds);
    if (n%7 == 3) return sourcestart(n-1,Math.pow(2,1/12),delayInSeconds);
    if (n%7 == 4) return sourcestart(n-2,Math.pow(2,2/12),delayInSeconds);
    if (n%7 == 5) return sourcestart(n-3,Math.pow(2,3/12),delayInSeconds);
    if (n%7 == 6) return sourcestart(n+3,Math.pow(2,-3/12),delayInSeconds);
    if (n%7 == 0) return sourcestart(n+2,Math.pow(2,-2/12),delayInSeconds);
    if (n%7 == 1) return sourcestart(n+1,Math.pow(2,-1/12),delayInSeconds);
  }

  function playpianosound(context,n,delayInSeconds) {
    playpiano7sound(n,delayInSeconds);
    //console.log("culo");
  }

  // borrar desde aca?
    function preloadoctaves(a,b)
  {
   if (a<3 || b>4) piano7loadall();
  }


  function isblackkey(n)
  {
   var i = n % 12;
   return (i==1 || i==3 || i==6 || i==8 || i==10);
  }

  function freq(n)
  {
   var f = 440*Math.pow(2,(n-69)/12);
   return f.toFixed(1);
  }

  function soundletter(n,sharp)
  {
   if (n<21 || n>109) { alert('wrong number for sound'); return '?'; }
   var names = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B','Cb'];
   if (sharp) names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B','B#']; 
   return names[n%12];
  }

  function soundnumber(n,sharp)
  {
   if (n<21 || n>109) { alert('wrong number for sound'); return '?'; }
   return Math.floor(n/12)-1;
  }

  function soundname(n,sharp)
  {
   return soundletter(n,sharp)+'<sub>'+soundnumber(n,sharp)+'</sub>';
  }

  var ileplayaudio = 0;
/*** borrar hasta aca?**/
  
  function playaudio(n) {
    playpianosound(audiocontext,n);
  }

  piano7loadbasic()
  
</script>
</head>
<body>
  <div id="contBand">
    <div id="row5"></div>
    <div id="row4"></div>
    <div id="row3"></div>
    <div id="row2"></div>
    <div id="row1"></div>
	</div>
  <br>
  <script>
  /*for(i=40;i<=75;i++) {
    var test = `<button onclick="playaudio(${i})">--${i}---</button>`
     $("body").append(test);
    
  }*/
  var notasText= ["C#4","A6","F#6","E6","Eb6",
					"C4","D4","G4","Bb5","C6","D6",
					"B3","E4","C#5","F#4","A4","C5","E5",
					"A3","F4","Bb4","G#4","B4","D5","G#5","B5",
					"Bb3","Eb4","F5","Eb5","F#5","A5","C#6","G5"];
	
	var colores = ["cyan","olive","yellow","gray"]
					
	var row = 5;
	
	var notas = [65, 90,87,51,115,52,88,69,83,84,53,70,89,68,71,85,82,72,86,73,67,66,188,74,78];
    
  for (var i = 1; i<35; i++){
		//var testo = `<div class="botonota">${notasText[i-1]}</div>`;
		var testo = `<div class="botonota" id="tecla${i}">${notasText[i-1]}</div>`;
		if (i==6 || i==12 || i == 19 || i == 27) row--;
		$("#row"+row).append(testo);
		$("#tecla"+i).css("background-color", colores[notasText[i-1].substr(-1)-3] );
	}
  
  function entrakeysalenota(n){
		var ret = notas.indexOf(n);
		$("body").append("<br>,"+n);
		return ret != -1 ? ret: 0;
	}
  
  function tirarnota(tecl){	
    console.log(tecl+39);
    
    playaudio(tecl+39);
  }
  </script>
</body>
</html>